{{- $grafana := index .Values "kube-prometheus-stack" "grafana" -}}
{{- $isDBURI := (ne .Values.promscale.connection.uri "")}}
{{ if and $grafana.enabled $grafana.timescale.datasource.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-grafana-db
  namespace: {{ template "tobs.namespace" . }}
  labels:
   app: {{ template "tobs.fullname" . }}
   chart: {{ template "tobs.chart" . }}
   release: {{ .Release.Name }}
data:
   add-users.sql: |-
    \set ON_ERROR_STOP on
    DO $$
      BEGIN
        CREATE ROLE prom_reader;
      EXCEPTION WHEN duplicate_object THEN
        RAISE NOTICE 'role prom_reader already exists, skipping create';
      END
    $$;
    DO $$
      BEGIN
        CREATE ROLE {{ $grafana.timescale.datasource.user }} WITH LOGIN PASSWORD '{{ $grafana.timescale.datasource.pass }}';
      EXCEPTION WHEN duplicate_object THEN
        RAISE NOTICE 'role {{ $grafana.timescale.datasource.user }} already exists, skipping create';
      END
    $$;
    GRANT prom_reader TO {{ $grafana.timescale.datasource.user }};
   wait-for-ts.sh: |-
    echo Checking if ${PGHOST} is up
    NUM_TIMES_FAILED=0;
    until nslookup ${PGHOST};
    do
      echo Num times failed: ${NUM_TIMES_FAILED}
      NUM_TIMES_FAILED=$(( $NUM_TIMES_FAILED + 1 ));
      if [ "${NUM_TIMES_FAILED}" -gt "5" ]
      then
        echo Failed 5 times while waiting for ${PGHOST}, exiting
        exit 1;
      fi
      echo Waiting 5 seconds;
      sleep 5;
      echo Checking if ${PGHOST} is up
    done
{{- end -}}